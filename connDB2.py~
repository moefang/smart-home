'''
Created on 08/2015

@author: fan03d

Download data according to the query.
'''
import datetime
from datetime import timedelta
import mysql.connector
import csv

cnx = mysql.connector.connect(user='fan03d', password='acbifan03dmoe', host='Mysqlprd-cdc.it.csiro.au', database='acbi')
cursor = cnx.cursor()

#query = ("SHOW tables in acbi")
#query = ("select scannerPos, local_time_string, rssi_string from acbi.estimote_beaconrecord where scannerPos='study' and local_time_string like '20151018230%'")

#query = ("select scannerPos, local_time_string, rssi_string from acbi.estimote_beaconrecord where local_time_string like '20151022%' or local_time_string like '20151023%'")

query=("select scannerPos, local_time_string, rssi_string from acbi.estimote_beaconrecord where local_time_string like '20151024%'")

#hire_start = datetime.date(1999, 1, 1)
#hire_end = datetime.date(1999, 12, 31)

#cursor.execute(query, (hire_start, hire_end))
cursor.execute(query)
fname="miband-3"
writer = csv.writer(open(fname, 'w'))

num_row =0
for (sp, lt, rssi_string) in cursor:
	#print type(rssi_string)
	time=datetime.datetime.strptime(lt, '%Y%m%d%H%M%S')
	#print time
	#time = time + timedelta(seconds=30)
	#print time
	print rssi_string
	rssi_str=rssi_string.encode('ascii')
	#print type(rssi_str)		
	offsets=rssi_str.rstrip("|").split("|")
	print offsets
	for item in offsets:
		#print item
		#print offsets
		try:
			it, ival = item.rstrip().split()
		except ValueError:
			print offsets
			print item
			pass

		#print it, ival			
		tstamp = time + timedelta(seconds=int(it))	
		print tstamp.strftime("%Y%m%d%H%M%S"), sp, ival
		writer.writerow([tstamp.strftime("%Y%m%d%H%M%S"), sp.rstrip(), ival])
	
	num_row = num_row +1
	print "# of records ", num_row

#writer.close()
cursor.close()
cnx.close()
